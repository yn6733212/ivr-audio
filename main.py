import requests
from urllib.parse import quote
from requests_toolbelt.multipart.encoder import MultipartEncoder
from datetime import datetime
import math

# ========= ×”×’×“×¨×•×ª =========
# ×™××•×ª
USERNAME = "0733181201"
PASSWORD = "6714453"
TOKEN = f"{USERNAME}:{PASSWORD}"
YEMOT_UPLOAD_URL = "https://www.call2all.co.il/ym/api/UploadFile"
YEMOT_TARGET_DIR = "ivr2:/7/"   # ×©×œ×•×—×” 7; ×•×“× ×©×™×© "/" ×‘×¡×•×£

# ×××’×¨ ×”××•×“×™×• ×©×œ×š ×‘-GitHub (RAW)
BASE_URL = "https://raw.githubusercontent.com/yn6733212/ivr-audio/main/assets/audio/"

# ×©× ×§×•×‘×¥ ×”×¤×ª×™×— ××¦×œ×š ×‘×××’×¨:
OPENING_CLIP = "×”×‘×™×˜×§×•×™×Ÿ ×¢×•××“ ×›×¢×ª ×¢×œ"  # ×§×•×‘×¥ ×‘×©× "×”×‘×™×˜×§×•×™×Ÿ ×¢×•××“ ×›×¢×ª ×¢×œ.wav"

# ========= ×¢×–×¨: ××™×¤×•×™×™ ×©××•×ª =========
# ×”×ª×××•×ª ×œ×©××•×ª ×”×§×‘×¦×™× ×©×”×¦×’×ª (×›×“×™ ×œ× ×œ×™×¤×•×œ ×¢×œ ×›×ª×™×‘×™× ×©×•× ×™×)
ALIASES = {
    # ×‘×¡×™×¡
    "××¤×¡": "××¤×¡",
    "××—×“": "××—×“",
    "×©×ª×™×™×": "×©×ª×™×™×",   # ×™×© ×œ×š ×’× "×©×ª×™.wav" â€“ × ×¢×“×™×£ "×©×ª×™×™×"
    "×©×ª×™": "×©×ª×™",
    "×©×œ×•×©": "×©×œ×•×©",
    "××¨×‘×¢": "××¨×‘×¢",
    "×—××©": "×—××©",
    "×©×©": "×©×©",
    "×©×‘×¢": "×©×‘×¢",
    "×©××•× ×”": "×©××•× ×”",
    "×ª×©×¢": "×ª×™×©×¢",      # ××¦×œ×š ×”×§×•×‘×¥ × ×§×¨× "×ª×™×©×¢.wav"
    # ×•×³ ×—×™×‘×•×¨ ×œ×™×—×™×“×•×ª
    "×•××—×“": "×•××—×“",
    "×•×©×ª×™×™×": "×•×©×ª×™×™×",
    "×•×©×œ×•×©": "×•×©×œ×•×©",
    "×•××¨×‘×¢": "×•××¨×‘×¢",
    "×•×—××©": "×•×—××©",
    "×•×©×©": "×•×©×©",
    "×•×©×‘×¢": "×•×©×‘×¢",
    "×•×©××•× ×”": "×•×©××•× ×”",
    "×•×ª×©×¢": "×•×ª×™×©×¢",     # ××¦×œ×š: "×•×ª×™×©×¢.wav"
    # 10â€“19
    "×¢×©×¨": "×¢×©×¨",
    "××—×“ ×¢×©×¨×”": "××—×“ ×¢×©×¨×”",
    "×©×ª×™× ×¢×©×¨×”": "×©×ª×™× ×¢×©×¨×”",
    "×©×œ×•×© ×¢×©×¨×”": "×©×œ×•×© ×¢×©×¨×”",
    "××¨×‘×¢ ×¢×©×¨×”": "××¨×‘×¢ ×¢×©×¨×”",
    "×—××© ×¢×©×¨×”": "×—××© ×¢×©×¨×”",
    "×©×© ×¢×©×¨×”": "×©×© ×¢×©×¨×”",
    "×©×‘×¢ ×¢×©×¨×”": "×©×‘×¢ ×¢×©×¨×”",
    "×©××•× ×” ×¢×©×¨×”": "×©××•× ×” ×¢×©×¨×”",
    "×ª×©×¢ ×¢×©×¨×”": "×ª×©×¢ ×¢×©×¨×”",
    # ×•×³ ×œ-10â€“19
    "×•×¢×©×¨": "×•×¢×©×¨",
    "×•××—×“ ×¢×©×¨×”": "×•××—×“ ×¢×©×¨×”",
    "×•×©×ª×™× ×¢×©×¨×”": "×•×©×ª×™× ×¢×©×¨×”",
    "×•×©×œ×•×© ×¢×©×¨×”": "×•×©×œ×•×© ×¢×©×¨×”",
    "×•××¨×‘×¢ ×¢×©×¨×”": "×•××¨×‘×¢ ×¢×©×¨×”",
    "×•×—××© ×¢×©×¨×”": "×•×—××© ×¢×©×¨×”",
    "×•×©×© ×¢×©×¨×”": "×•×©×© ×¢×©×¨×”",
    "×•×©×‘×¢ ×¢×©×¨×”": "×•×©×‘×¢ ×¢×©×¨×”",
    "×•×©××•× ×” ×¢×©×¨×”": "×•×©××•× ×” ×¢×©×¨×”",
    "×•×ª×©×¢ ×¢×©×¨×”": "×•×ª×©×¢ ×¢×©×¨×”",
    # ×¢×©×¨×•×ª
    "×¢×©×¨×™×": "×¢×©×¨×™×",
    "×©×œ×•×©×™×": "×©×œ×•×©×™×",
    "××¨×‘×¢×™×": "××¨×‘×¢×™×",
    "×—××™×©×™×": "×—××™×©×™×",
    "×©×™×©×™×": "×©×™×©×™×",
    "×©×‘×¢×™×": "×©×‘×¢×™×",
    "×©××•× ×™×": "×©××•× ×™×",
    "×ª×©×¢×™×": "×ª×©×¢×™×",
    # ×•×³ ×œ×¢×©×¨×•×ª
    "×•×¢×©×¨×™×": "×•×¢×©×¨×™×",
    "×•×©×œ×•×©×™×": "×•×©×œ×•×©×™×",   # ××¦×œ×š ×–×” ×›×ª×•×‘ ×¢× ×•×³ ×©×•× ×” â€“ "×•×©×œ×•×©×™×.wav"
    "×•××¨×‘×¢×™×": "×•××¨×‘×¢×™×",
    "×•×—××™×©×™×": "×•×—××™×©×™×",
    "×•×©×™×©×™×": "×•×©×™×©×™×",
    "×•×©×‘×¢×™×": "×•×©×‘×¢×™×",
    "×•×©××•× ×™×": "×•×©××•× ×™×",
    "×•×ª×©×¢×™×": "×•×ª×©×¢×™×",
    # ×××•×ª
    "×××”": "×××”",
    "×××ª×™×™×": "×××ª×™×™×",
    "×©×œ×•×© ×××•×ª": "×©×œ×•×© ×××•×ª",
    "××¨×‘×¢ ×××•×ª": "××¨×‘×¢ ×××•×ª",
    "×—××© ×××•×ª": "×—××© ×××•×ª",
    "×©×© ×××•×ª": "×©×© ×××•×ª",
    "×©×‘×¢ ×××•×ª": "×©×‘×¢ ×××•×ª",
    "×©××•× ×” ×××•×ª": "×©××•× ×” ×××•×ª",
    # ×©×™× ×œ×‘: "×ª×©×¢ ×××•×ª" ××™×Ÿ ×‘×¨×©×™××” ×©×œ×š â€“ ×× ×ª×•×¡×™×£, ×ª×¨×—×™×‘ ×¤×”
    # ××œ×¤×™×
    "××œ×£": "××œ×£",
    "××œ×¤×™×™×": "××œ×¤×™×™×",
    "×©×œ×•×©×ª ××œ×¤×™×": "×©×œ×•×©×ª ××œ×¤×™×",
    "××¨×‘×¢×ª ××œ×¤×™×": "××¨×‘×¢×ª ××œ×¤×™×",
    "×—××©×ª ××œ×¤×™×": "×—××©×ª ××œ×¤×™×",
    "×©×©×ª ××œ×¤×™×": "×©×©×ª ××œ×¤×™×",
    "×©×‘×¢×ª ××œ×¤×™×": "×©×‘×¢×ª ××œ×¤×™×",
    "×©××•× ×ª ××œ×¤×™×": "×©××•× ×ª ××œ×¤×™×",
    "×ª×©×¢×ª ××œ×¤×™×": "×ª×©×¢×ª ××œ×¤×™×",
    # ××™×œ×™× ×›×œ×œ×™×•×ª
    "× ×§×•×“×”": "× ×§×•×“×”",
    "×“×•×œ×¨": "×“×•×œ×¨",
    "××—×•×–": "××—×•×–",
    # ×¤×ª×™×—
    "×”×‘×™×˜×§×•×™×Ÿ ×¢×•××“ ×›×¢×ª ×¢×œ": "×”×‘×™×˜×§×•×™×Ÿ ×¢×•××“ ×›×¢×ª ×¢×œ",
}

UNITS = ["××¤×¡","××—×“","×©×ª×™×™×","×©×œ×•×©","××¨×‘×¢","×—××©","×©×©","×©×‘×¢","×©××•× ×”","×ª×©×¢"]
TEENS = ["×¢×©×¨","××—×“ ×¢×©×¨×”","×©×ª×™× ×¢×©×¨×”","×©×œ×•×© ×¢×©×¨×”","××¨×‘×¢ ×¢×©×¨×”","×—××© ×¢×©×¨×”","×©×© ×¢×©×¨×”","×©×‘×¢ ×¢×©×¨×”","×©××•× ×” ×¢×©×¨×”","×ª×©×¢ ×¢×©×¨×”"]
TENS  = ["","×¢×©×¨","×¢×©×¨×™×","×©×œ×•×©×™×","××¨×‘×¢×™×","×—××™×©×™×","×©×™×©×™×","×©×‘×¢×™×","×©××•× ×™×","×ª×©×¢×™×"]
HUNDREDS = ["","×××”","×××ª×™×™×","×©×œ×•×© ×××•×ª","××¨×‘×¢ ×××•×ª","×—××© ×××•×ª","×©×© ×××•×ª","×©×‘×¢ ×××•×ª","×©××•× ×” ×××•×ª"]  # ××™×Ÿ "×ª×©×¢ ×××•×ª" ××¦×œ×š ×›×¨×’×¢

def build_raw_url(word: str) -> str:
    """×‘×•× ×” URL ×œ×§×•×‘×¥ ×‘×××’×¨, ×›×•×œ×œ ×§×™×“×•×“ ×©× ×”×§×•×‘×¥ ×‘×¢×‘×¨×™×ª."""
    name = ALIASES.get(word, word)
    return BASE_URL + quote(name + ".wav", safe="/:")

def fetch_clip_bytes(word: str) -> bytes:
    url = build_raw_url(word)
    r = requests.get(url)
    if r.status_code != 200:
        raise FileNotFoundError(f"×œ× × ××¦× ×§×•×‘×¥ ×¢×‘×•×¨ '{word}' ({url})")
    return r.content

def upload_clip(file_bytes: bytes, target_filename: str):
    m = MultipartEncoder(fields={
        "token": TOKEN,
        "path": YEMOT_TARGET_DIR + target_filename,
        "file": (target_filename, file_bytes, "audio/wav")
    })
    resp = requests.post(YEMOT_UPLOAD_URL, data=m, headers={"Content-Type": m.content_type})
    if "success" in resp.text.lower():
        print(f"âœ… {target_filename} ×”×•×¢×œ×” ×‘×”×¦×œ×—×” ({datetime.now().strftime('%H:%M:%S')})")
    else:
        print(f"âš ï¸ ×©×’×™××” ×‘×”×¢×œ××ª {target_filename}: {resp.text}")

# ===== ×¤×™×¨×•×§ ××¡×¤×¨ â†’ ××™×œ×™× (××•×ª×× ×œ×§×‘×¦×™× ×©×™×© ×œ×š) =====
def two_digits_tokens(n: int, with_leading_vav: bool=False) -> list[str]:
    """0..99. ×× with_leading_vav=True × × ×¡×” ×œ×”×©×ª××© ×‘×¦×•×¨×ª '×•×¢×©×¨×™×/×•×©×ª×™×™×' ×•×›×•'."""
    if n < 10:
        if with_leading_vav and n != 0:
            vmap = ["", "×•××—×“","×•×©×ª×™×™×","×•×©×œ×•×©","×•××¨×‘×¢","×•×—××©","×•×©×©","×•×©×‘×¢","×•×©××•× ×”","×•×ª×©×¢"]
            return [vmap[n]]
        return [UNITS[n]]

    if 10 <= n < 20:
        teens = TEENS[n-10]
        if with_leading_vav:
            return ["×•"+teens]  # ×™×© ×œ×š ×§×‘×¦×™× ×›××• "×•×¢×©×¨","×•××—×“ ×¢×©×¨×”","×•×¢×•×“..."
        return [teens]

    tens = n // 10
    ones = n % 10
    if ones == 0:
        t = TENS[tens]
        return [("×•"+t) if with_leading_vav else t]

    # 21..99: "×¢×©×¨×™× ×•×©×ª×™×™×"
    tokens = [TENS[tens]]
    tokens += two_digits_tokens(ones, with_leading_vav=True)  # ×œ×™×—×™×“×” × ×•×¡×™×£ ×•×³-×—×™×‘×•×¨
    if with_leading_vav:
        tokens[0] = "×•" + tokens[0]  # ×œ×”×¤×•×š "×¢×©×¨×™×" ×œ"×•×¢×©×¨×™×" ×›×©×–×” ×‘× ×¢× ×—×™×‘×•×¨ ××”×§×•×“×
    return tokens

def three_digits_tokens(n: int, with_leading_vav: bool=False) -> list[str]:
    """0..999. ×œ× × ×©×ª××© ×‘'×•×××”/×•×××ª×™×™×' ×›×™ ××™×Ÿ ×œ×š ××ª ×”×§×‘×¦×™× ×”×œ×œ×•."""
    if n < 100:
        return two_digits_tokens(n, with_leading_vav=with_leading_vav)

    h = n // 100
    rest = n % 100
    parts = [HUNDREDS[h]]
    if rest == 0:
        if with_leading_vav:
            # ××™×Ÿ ×œ× ×• '×•×××”' ×•×›×•' â€“ × ×©××™×¨ ×‘×œ×™ ×•×³ (×™×”×™×”: "... ×•××¨×‘×¢×™× | ×××”")
            pass
        return parts

    # ×‘×™×Ÿ ×××•×ª ×œ×©××¨ â€“ **× ×™×× ×¢** ××•×³ ×œ×¤× ×™ ×”"×××•×ª" (××™×Ÿ ×§×œ×™×¤×™× ×›××œ×”),
    # ××‘×œ ×›×Ÿ × ×•×¡×™×£ ×•×³ ×œ×¤× ×™ ×”×—×œ×§ ×©××ª×—×ª ×œ×××”:
    parts += two_digits_tokens(rest, with_leading_vav=True)
    if with_leading_vav:
        # ×”×™×™× ×• ×¨×•×¦×™× '×•[×××•×ª]' ××‘×œ ××™×Ÿ ×§×œ×™×¤ ×›×–×” â€“ × ×©××™×¨ ×‘×œ×™.
        pass
    return parts

def thousands_tokens(n: int) -> list[str]:
    """0..999,999"""
    if n < 1000:
        return three_digits_tokens(n)

    thousands = n // 1000
    below = n % 1000
    parts = []

    if thousands == 1:
        parts += ["××œ×£"]
    elif thousands == 2:
        parts += ["××œ×¤×™×™×"]
    elif 3 <= thousands <= 9:
        spec = {
            3: "×©×œ×•×©×ª ××œ×¤×™×", 4: "××¨×‘×¢×ª ××œ×¤×™×", 5: "×—××©×ª ××œ×¤×™×",
            6: "×©×©×ª ××œ×¤×™×", 7: "×©×‘×¢×ª ××œ×¤×™×", 8: "×©××•× ×ª ××œ×¤×™×", 9: "×ª×©×¢×ª ××œ×¤×™×"
        }
        parts += [spec[thousands]]
    else:
        # 10..99 ××œ×£
        parts += two_digits_tokens(thousands) + ["××œ×¤×™×"]

    if below > 0:
        # × ×¢×“×™×£ ×•×³ ×œ×¤× ×™ ××” ×©××ª×—×ª ×œ××œ×¤×™×, ××‘×œ ×‘×œ×™ ×•×³ ×œ×¤× ×™ ×××•×ª (××™×Ÿ ×§×œ×™×¤ '×•×××”')
        # ×œ×›×Ÿ: ×× below < 100 â†’ × ×›× ×™×¡ ×¢× ×•×³; ×× 100..999 â†’ ×××•×ª ×‘×œ×™ ×•×³ ×•××– ×”×©××¨ ×¢× ×•×³
        if below < 100:
            parts += two_digits_tokens(below, with_leading_vav=True)
        else:
            parts += three_digits_tokens(below)  # ×××•×ª ×‘×œ×™ ×•×³
    return parts

def number_to_tokens(n: int) -> list[str]:
    if n == 0:
        return ["××¤×¡"]
    if n < 0:
        n = abs(n)  # ××¤×©×¨ ×œ×”×•×¡×™×£ "××™× ×•×¡" ×× ×ª×§×œ×™×˜
    if n >= 1_000_000:
        # ××¤×©×¨ ×œ×”×¨×—×™×‘ ×× ×ª×•×¡×™×£ ×§×œ×™×¤×™× ×œ×¢×©×¨×•×ª/×××•×ª ××œ×¤×™×
        raise ValueError("× ×›×•×Ÿ ×œ×¢×›×©×™×• ×ª×•××š ×¢×“ 999,999")
    return thousands_tokens(n)

# ========= ×©×œ×™×¤×ª ××—×™×¨ ×”×‘×™×˜×§×•×™×Ÿ =========
def fetch_btc_usd() -> float:
    """×¤×©×•×˜ ×•××”×™×¨: CoinGecko API."""
    url = "https://api.coingecko.com/api/v3/simple/price"
    params = {"ids":"bitcoin", "vs_currencies":"usd"}
    r = requests.get(url, params=params, timeout=10)
    r.raise_for_status()
    data = r.json()
    price = float(data["bitcoin"]["usd"])
    return price

# ========= ××”×œ×š ×¨××©×™ =========
def main():
    # 1) ×¤×ª×™×—
    sequence_words = [OPENING_CLIP]

    # 2) ××—×™×¨ ×”×‘×™×˜×§×•×™×Ÿ (× ×¢×’×œ ×œ×©"×—? ×œ× â€“ ×›×¨×’×¢ ×“×•×œ×¨ ×©×œ× ×‘×œ×‘×“, ××¤×©×¨ ×œ×©× ×•×ª)
    price_usd = fetch_btc_usd()

    # ×× ×ª×¨×¦×” ×¢×™×’×•×œ ×œ××œ×¤×™×: n = round(price_usd, -3)
    # ×›××Ÿ × ×¢×’×œ ×œ×©×œ× (×œ×œ× × ×§×•×“×”). ××¤×©×¨ ×’× ×œ×”×©××™×¢ ×¢×©×¨×•× ×™×™× ×× ×ª×¨×¦×”.
    n = int(round(price_usd))

    # 3) ×”××¡×¤×¨ ×›××™×œ×™×
    num_words = number_to_tokens(n)

    # 4) ×”×•×¡×¤×ª "×“×•×œ×¨" (×× ×™×© ×œ×š ×”×§×œ×˜×”)
    sequence_words += num_words + ["×“×•×œ×¨"]

    # ====== ×”×¢×œ××” ×œ×™××•×ª ×›×¨×¦×£ 001..00N ======
    print("ğŸ“ ×˜×•×§× ×™×:", " | ".join(sequence_words))

    # ×”×•×¨×“×” ×•×”×¢×œ××” ××—×“-××—×“ ×œ×¤×™ ××™× ×“×§×¡
    idx = 1
    for w in sequence_words:
        clip_bytes = fetch_clip_bytes(w)
        fname = f"{idx:03}.wav"
        upload_clip(clip_bytes, fname)
        idx += 1

    print("ğŸ‰ ×¡×™×™××ª×™ ×œ×”×¢×œ×•×ª ×¢×“", f"{idx-1:03}.wav")

if __name__ == "__main__":
    main()
